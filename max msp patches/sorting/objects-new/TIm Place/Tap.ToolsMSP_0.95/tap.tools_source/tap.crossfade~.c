// MSP External: tap.crossfade~.c// crossfading external for MSP// T.Place - 05.29.2001//		v1.1 (08/27/01) - update for Max/MSP 4//		v1.2 (11/30/01) - minor revisions#include "ext.h"				// Required for all Max External Objects#include "z_dsp.h"			// Required for all MSP External Objects#include <math.h>			// Required for sin function#include <stdlib.h>#include "ext_strings.h"		// Used for the assistance stringsvoid *fade_class;			// Required. Global pointing to this class						// Lookup Table for "fast" crossfadingdouble	Gfade_table[512]={ 0.999939, 0.999908, 0.999939, 0.999908, 0.999908, 0.999847, 0.999817, 0.999756, 0.999664, 0.999695,     						0.999512, 0.999481, 0.999298, 0.999298, 0.999146, 0.998993, 0.998840, 0.998779, 0.998505, 0.998474,     						0.998169, 0.998047, 0.997864, 0.997650, 0.997406, 0.997253, 0.996918, 0.996765, 0.996521, 0.996155,     						0.996033, 0.995667, 0.995331, 0.995209, 0.994690, 0.994568, 0.994049, 0.993866, 0.993500, 0.993073,     						0.992767, 0.992371, 0.992004, 0.991608, 0.991241, 0.990753, 0.990387, 0.989960, 0.989532, 0.989044,     						0.988617, 0.988098, 0.987732, 0.987183, 0.986633, 0.986267, 0.985565, 0.985229, 0.984589, 0.984131,     						0.983429, 0.983032, 0.982391, 0.981842, 0.981171, 0.980713, 0.980011, 0.979431, 0.978729, 0.978241,     						0.977478, 0.976868, 0.976227, 0.975525, 0.974823, 0.974243, 0.973419, 0.972809, 0.972015, 0.971375,     						0.970551, 0.969849, 0.969116, 0.968323, 0.967529, 0.966858, 0.965912, 0.965210, 0.964386, 0.963562,     						0.962738, 0.961945, 0.960999, 0.960236, 0.959351, 0.958466, 0.957611, 0.956696, 0.955811, 0.954895,     						0.953979, 0.953064, 0.952118, 0.951172, 0.950226, 0.949310, 0.948242, 0.947357, 0.946259, 0.945404,     						0.944305, 0.943298, 0.942291, 0.941223, 0.940247, 0.939148, 0.938080, 0.937073, 0.935883, 0.934937,     						0.933716, 0.932678, 0.931549, 0.930481, 0.929260, 0.928162, 0.927002, 0.925903, 0.924683, 0.923523,     						0.922272, 0.921234, 0.919922, 0.918701, 0.917542, 0.916290, 0.915070, 0.913788, 0.912598, 0.911285,     						0.910034, 0.908722, 0.907501, 0.906189, 0.904846, 0.903534, 0.902222, 0.900970, 0.899536, 0.898193,     						0.896881, 0.895508, 0.894165, 0.892670, 0.891418, 0.889923, 0.888611, 0.887085, 0.885773, 0.884216,     						0.882965, 0.881287, 0.880005, 0.878479, 0.876984, 0.875610, 0.873932, 0.872589, 0.871063, 0.869476,     						0.868011, 0.866516, 0.864899, 0.863373, 0.861877, 0.860229, 0.858765, 0.857056, 0.855591, 0.853912,     						0.852325, 0.850739, 0.849091, 0.847534, 0.845764, 0.844238, 0.842560, 0.840851, 0.839264, 0.837524,     						0.835876, 0.834167, 0.832489, 0.830719, 0.829132, 0.827271, 0.825592, 0.823883, 0.822113, 0.820343,     						0.818634, 0.816803, 0.815033, 0.813324, 0.811401, 0.809723, 0.807861, 0.806030, 0.804291, 0.802338,     						0.800598, 0.798706, 0.796844, 0.795044, 0.793091, 0.791260, 0.789398, 0.787476, 0.785583, 0.783661,     						0.781799, 0.779816, 0.777954, 0.775970, 0.774017, 0.772156, 0.770111, 0.768127, 0.766266, 0.764191,     						0.762268, 0.760193, 0.758331, 0.756165, 0.754242, 0.752228, 0.750183, 0.748108, 0.746124, 0.744019,     						0.742035, 0.739899, 0.737854, 0.735779, 0.733673, 0.731659, 0.729431, 0.727448, 0.725220, 0.723206,     						0.721008, 0.718964, 0.716644, 0.714752, 0.712341, 0.710358, 0.708099, 0.705994, 0.703766, 0.701599,     						0.699371, 0.697235, 0.694946, 0.692810, 0.690552, 0.688324, 0.686096, 0.683868, 0.681580, 0.679382,     						0.677155, 0.674744, 0.672638, 0.670258, 0.668030, 0.665710, 0.663422, 0.661102, 0.658844, 0.656494,     						0.654144, 0.651886, 0.649445, 0.647247, 0.644745, 0.642517, 0.640106, 0.637756, 0.635315, 0.633118,     						0.630493, 0.628326, 0.625763, 0.623505, 0.620941, 0.618683, 0.616180, 0.613770, 0.611359, 0.608856,     						0.606537, 0.603973, 0.601593, 0.599121, 0.596649, 0.594147, 0.591766, 0.589172, 0.586761, 0.584229,     						0.581757, 0.579254, 0.576721, 0.574188, 0.571777, 0.569092, 0.566742, 0.564026, 0.561615, 0.558990,     						0.556519, 0.553925, 0.551331, 0.548767, 0.546295, 0.543610, 0.541016, 0.538544, 0.535828, 0.533325,     						0.530640, 0.528107, 0.525421, 0.522858, 0.520203, 0.517578, 0.515015, 0.512238, 0.509766, 0.506927,     						0.504486, 0.501648, 0.499115, 0.496338, 0.493774, 0.491028, 0.488403, 0.485657, 0.483032, 0.480255,     						0.477631, 0.474915, 0.472198, 0.469482, 0.466705, 0.464142, 0.461243, 0.458649, 0.455811, 0.453156,     						0.450378, 0.447632, 0.444824, 0.442169, 0.439423, 0.436493, 0.433899, 0.431061, 0.428253, 0.425568,     						0.422668, 0.419952, 0.417145, 0.414368, 0.411499, 0.408813, 0.405853, 0.403229, 0.400208, 0.397552,     						0.394653, 0.391876, 0.388977, 0.386200, 0.383331, 0.380554, 0.377625, 0.374786, 0.372009, 0.369080,     						0.366241, 0.363403, 0.360504, 0.357697, 0.354706, 0.351929, 0.349030, 0.346191, 0.343170, 0.340424,     						0.337463, 0.334595, 0.331696, 0.328766, 0.325897, 0.322968, 0.320038, 0.317230, 0.314117, 0.311401,     						0.308350, 0.305511, 0.302490, 0.299622, 0.296661, 0.293732, 0.290802, 0.287872, 0.284882, 0.281952,     						0.279022, 0.276031, 0.273163, 0.270050, 0.267242, 0.264160, 0.261292, 0.258301, 0.255280, 0.252319,     						0.249420, 0.246368, 0.243347, 0.240509, 0.237396, 0.234436, 0.231476, 0.228485, 0.225464, 0.222443,     						0.219513, 0.216461, 0.213531, 0.210419, 0.207489, 0.204437, 0.201477, 0.198456, 0.195404, 0.192413,     						0.189423, 0.186340, 0.183411, 0.180267, 0.177338, 0.174316, 0.171204, 0.168213, 0.165253, 0.16214,     						0.159088, 0.156158, 0.153015, 0.149994, 0.147003, 0.143951, 0.1409, 0.137787, 0.134857, 0.131714,     						0.128754, 0.125641, 0.122589, 0.119568, 0.116547, 0.113373, 0.110443, 0.10733, 0.10434, 0.101166,     						0.098175, 0.095154, 0.09201, 0.08902, 0.085907, 0.082855, 0.079865, 0.07666, 0.07373, 0.070557,     						0.067596, 0.064392, 0.061493, 0.058319, 0.055237, 0.052216, 0.049164, 0.04599, 0.04306, 0.039856,     						0.036896, 0.033752, 0.030701, 0.027618, 0.024567, 0.021484, 0.018402, 0.01532, 0.012268,0.009216, 0.006042, 0.0};	typedef struct _fade			// Data Structure for this object{    t_pxobject 	x_obj;    double 		fade_mult;		// percentage of output made up by the second inlet    int 		fade_mode;		// Number of inlets created by the _new method    int		fade_shape;		// Linear or Equal-Power} t_fade;// Prototypes for methods: need a method for each incoming message typevoid *fade_new(long mode, long shape);						// New Object Creation Methodt_int *fade_perform1(t_int *w);							// An MSP Perform (signal) Methodt_int *fade_perform2(t_int *w);							// An MSP Perform (signal) Methodt_int *fade_perform3(t_int *w);							// An MSP Perform (signal) Methodt_int *fade_perform4(t_int *w);							// An MSP Perform (signal) Methodvoid fade_dsp(t_fade *x, t_signal **sp, short *count);			// DSP Methodvoid fade_assist(t_fade *x, void *b, long m, long a, char *s);		// Assistance Methodvoid fade_float(t_fade *x, double value );						// Float Methodvoid fade_shape(t_fade *x, long value);						// Current Shape (linear or eq-pow_)void fade_mode(t_fade *x, long value);						// Current Mode (fast or precision)float fclip(float a, float b, float c);							// Utility to keep coefficients in checkvoid crossfade_free(t_fade *x);/************************************************************************************/// Main() Functionvoid main(void)				// main recieves a copy of the Max function macros table{	setup((t_messlist **)&fade_class, (method)fade_new, (method)crossfade_free, (short)sizeof(t_fade), 0L, A_DEFLONG, A_DEFLONG, 0);	addmess((method)fade_dsp, "dsp", A_CANT, 0);					// Bind method "fade_dsp" to the DSP call from MSP	addmess((method)fade_assist, "assist", A_CANT, 0);				// Bind method "fade_assist" to assistance calls	addfloat((method)fade_float);	addmess((method)fade_shape, "shape", A_LONG, 0);	addmess((method)fade_mode, "mode", A_LONG, 0);	addmess((method)inspector_open, "info", A_CANT, 0);				// bind method for opening the license window		dsp_initclass();												// Setup object's class to work with MSP	post("tap.crossfade~ v1.2 - Copyright © 2001 by Timothy A. Place");	// Print to the Max Window...	post("     Impact Center @ University of Missouri - Kansas City / Silicon Prairie Intermedia");}/************************************************************************************/// Object Creation Methodvoid *fade_new(long mode, long shape){	t_fade *x = (t_fade *)newobject(fade_class);	    	dsp_setup((t_pxobject *)x, 3);				// Create Object and 3 Inlets (last argument)	outlet_new((t_pxobject *)x, "signal");		// Create a signal Outlet   	x->fade_mode = mode;	x->fade_shape = shape;	return (x);							// Return the pointer}/************************************************************************************/// Methods bound to input/inlets// Method for Assistance Messagesvoid fade_assist(t_fade *x, void *b, long msg, long arg, char *dst){	if(msg==1){ 	// Inlets		switch(arg){			case 0: strcpy(dst, "(signal) Input signal #1"); break;			case 1: strcpy(dst, "(signal) Input signal #2"); break;			case 2: strcpy(dst, "(signal/float) Control <0 to 1>"); break;		}	}	else if(msg==2) // Outlets		strcpy(dst, "(signal) Crossfaded output");}// Float Methodvoid fade_float(t_fade *x, double value){	x->fade_mult = fclip(value, 0.0, 1.0);}// Shape Methodvoid fade_shape(t_fade *x, long value){	x->fade_shape = value;}// Mode Methodvoid fade_mode(t_fade *x, long value){	x->fade_mode = value;}// Memory Deallocationvoid crossfade_free(t_fade *x){	notify_free((t_object *)x);	dsp_free((t_pxobject *)x);}// Perform (signal) Method1	-	FAST w/ control rate fadingt_int *fade_perform1(t_int *w){	t_float *in1 = (t_float *)(w[1]);			// Input1	t_float *in2 = (t_float *)(w[2]);			// Input2	t_float *out = (t_float *)(w[3]);			// Output   	t_fade *x = (t_fade *)(w[4]);				// Pointer	int n = (int)(w[5]);						// Vector Size	double 	input1, input2, val;	int		index;										if (x->x_obj.z_disabled) return (w+6);	while (--n) 	{		input1 = *++in1;		input2 = *++in2;		if (x->fade_shape == 0)		// EQUAL-POWER FADE		{			index = (int)(x->fade_mult * 511);			val = (input2 * Gfade_table[511 - index]) + (input1 * Gfade_table[index]);		}		else	// LINEAR FADE			val = (input2 * x->fade_mult) + (input1 * (1.0 - x->fade_mult));		*++out = val;				// Output	}		return (w + 6);					// Return a pointer to the NEXT object in the DSP call chain}// Perform (signal) Method2	-	FAST w/ signal rate fadingt_int *fade_perform2(t_int *w){	t_float *in1 = (t_float *)(w[1]);			// Input1	t_float *in2 = (t_float *)(w[2]);			// Input2	t_float *in3 = (t_float *)(w[3]);			// Input3 - Control signal	t_float *out = (t_float *)(w[4]);			// Output   	t_fade *x = (t_fade *)(w[5]);				// Pointer	int n = (int)(w[6]);						// Vector Size	double 	input1, input2, val;	int		index;										if (x->x_obj.z_disabled) return (w+7);	while (--n) 	{		input1 = *++in1;		input2 = *++in2;		val = *++in3;		val = fclip(val, 0.0, 1.0);		// constrain control values				if (x->fade_shape == 0)		// EQUAL-POWER FADE		{			index = (int)(val * 511);			val = (input2 * Gfade_table[511 - index]) + (input1 * Gfade_table[index]);		}		else	// LINEAR FADE			val = (input2 * val) + (input1 * (1.0 - val));		*++out = val;				// Output	}		return (w + 7);					// Return a pointer to the NEXT object in the DSP call chain}// Perform (signal) Method3	-	PRECISION w/ signal rate fadingt_int *fade_perform3(t_int *w){	t_float *in1 = (t_float *)(w[1]);			// Input1	t_float *in2 = (t_float *)(w[2]);			// Input2	t_float *in3 = (t_float *)(w[3]);	t_float *out = (t_float *)(w[4]);			// Output   	t_fade *x = (t_fade *)(w[5]);				// Pointer	int n = (int)(w[6]);						// Vector Size	double 	input1, input2, val;									if (x->x_obj.z_disabled) return (w+7);	while (--n) 	{		input1 = *++in1;		input2 = *++in2;		val = *++in3;				if (x->fade_shape == 0)		// EQUAL-POWER FADE			val = (input2 * (sin(val * 1.5707963))) + (input1 * (sin((1 - val) * 1.5707963)));		else						// LINEAR FADE			val = (input2 * val) + (input1 * (1.0 - val));		*++out = val;				// Output	}		return (w + 7);					// Return a pointer to the NEXT object in the DSP call chain}// Perform (signal) Method4	-	PRECISION w/ control rate fadingt_int *fade_perform4(t_int *w){	t_float *in1 = (t_float *)(w[1]);			// Input1	t_float *in2 = (t_float *)(w[2]);			// Input2	t_float *out = (t_float *)(w[3]);			// Output   	t_fade *x = (t_fade *)(w[4]);				// Pointer	int n = (int)(w[5]);						// Vector Size	double 	input1, input2, val;								if (x->x_obj.z_disabled) return (w+6);	while (--n) 	{		input1 = *++in1;		input2 = *++in2;		val = x->fade_mult;		if (x->fade_shape == 0)		// EQUAL-POWER FADE			val = (input2 * (sin(val * 1.5707963))) + (input1 * (sin((1 - val) * 1.5707963)));		else						// LINEAR FADE			val = (input2 * x->fade_mult) + (input1 * (1.0 - x->fade_mult));		*++out = val;				// Output	}		return (w + 6);					// Return a pointer to the NEXT object in the DSP call chain}// DSP Methodvoid fade_dsp(t_fade *x, t_signal **sp, short *count){	if ((count[2])&&(x->fade_mode == 0))			// signal fader and table lookup		dsp_add(fade_perform2, 6, sp[0]->s_vec-1, sp[1]->s_vec-1, sp[2]->s_vec-1,			sp[3]->s_vec-1, x, sp[0]->s_n+1);	else if ((count[2])&&(x->fade_mode != 0))			// signal fader and live math		dsp_add(fade_perform3, 6, sp[0]->s_vec-1, sp[1]->s_vec-1, sp[2]->s_vec-1,			sp[3]->s_vec-1, x, sp[0]->s_n+1);			else if (x->fade_mode == 0)					// control fader and table lookup		dsp_add(fade_perform1, 5, sp[0]->s_vec-1, sp[1]->s_vec-1, 			sp[3]->s_vec-1, x, sp[0]->s_n+1);				else										// control fader and live math		dsp_add(fade_perform4, 5, sp[0]->s_vec-1, sp[1]->s_vec-1, 			sp[3]->s_vec-1, x, sp[0]->s_n+1);								}/************************************************************************************/// Other Functions used by object// clipping utilityfloat fclip(float a, float b, float c){	return a < b? b: (a > c? c : a);}