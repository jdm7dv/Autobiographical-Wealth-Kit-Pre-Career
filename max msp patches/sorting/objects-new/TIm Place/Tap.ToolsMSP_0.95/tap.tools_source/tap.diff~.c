// MSP External: tap.diff~.c// diff generator// T.Place - 05.13.2001//		v0.6 (08/27/2001) - update for Max/MSP 4//		v0.7 (11/30/2001) - minor revisions#include "ext.h"			// Required for all Max External Objects#include "z_dsp.h"		// Required for all MSP External Objects#include "ext_strings.h"	// Used for the assistance stringsvoid *diff_class;		// Required. Global pointing to this classtypedef struct _diff		// Data Structure for this object{	t_pxobject x_obj;	float 	diff_b1; } t_diff;// Prototypes for methods: need a method for each incoming message typevoid *diff_new(void);									// New Object Creation Methodt_int *diff_perform(t_int *w);							// An MSP Perform (signal) Methodvoid diff_dsp(t_diff *x, t_signal **sp, short *count);		// DSP Methodvoid diff_assist(t_diff *x, void *b, long m, long a, char *s);	// Assistance Methoddouble fclip(double a, double b, double c);					//void diff_free(t_diff *x);/************************************************************************************/// Main() Functionvoid main(void)				// main recieves a copy of the Max function macros table{	setup((t_messlist **)&diff_class, (method)diff_new, (method)diff_free, (short)sizeof(t_diff), 0L, 0);	addmess((method)diff_dsp, "dsp", A_CANT, 0);					// Bind method "diff_dsp" to the DSP call from MSP	addmess((method)diff_assist, "assist", A_CANT, 0);				// Bind method "diff_assist" to assistance calls	addmess((method)inspector_open, "info", A_CANT, 0);			// bind method for opening the license window		dsp_initclass();											// Setup object's class to work with MSP	post("tap.diff~ v0.7 - Copyright © 2001 by Timothy A. Place");		// Print to the Max Window...	post("     Impact Center @ University of Missouri - Kansas City / Silicon Prairie Intermedia");}/************************************************************************************/// Object Creation Methodvoid *diff_new(void){	t_diff *x = (t_diff *)newobject(diff_class);		dsp_setup((t_pxobject *)x,1);				// Create Object and 1 Inlet (last argument)	outlet_new((t_pxobject *)x, "signal");		// Create a signal Outlet  	x->diff_b1 = 0;							// initialize value	return (x);							// Return the pointer}/************************************************************************************/// Methods bound to input/inlets// Method for Assistance Messagesvoid diff_assist(t_diff *x, void *b, long msg, long arg, char *dst){	if(msg==1) 	// Inlets		strcpy(dst, "(signal) Input");	else if(msg==2) // Outlets		strcpy(dst, "(signal) Filtered Output");}// Memory Deallocationvoid diff_free(t_diff *x){	notify_free((t_object *)x);	dsp_free((t_pxobject *)x);}// Perform (signal) Methodt_int *diff_perform(t_int *w){	t_float *in = (t_float *)(w[1]);		// Input	t_float *out = (t_float *)(w[2]);	// Output   	t_diff *x = (t_diff *)(w[3]);		// Pointer	int n = (int)(w[4]);				// Vector Size		double	val;							if (x->x_obj.z_disabled) return (w+5);	while (--n)	{		val = *++in;				// Input		val = val - x->diff_b1;		// 6dB per octave highpass		val = fclip(val, -1., 1.);		// Clip 		*++out = val;				// Output		x->diff_b1 = val;			// Store Feedback Sample	}			return (w + 5);					// Return a pointer to the NEXT object in the DSP call chain}// DSP Methodvoid diff_dsp(t_diff *x, t_signal **sp, short *count){		x->diff_b1 = 0;								dsp_add(diff_perform, 4, sp[0]->s_vec-1, sp[1]->s_vec-1, x, sp[0]->s_n+1);}/************************************************************************************/// Other Functions used by object// Utility function to keep values in rangedouble fclip(double a, double b, double c){	return a < b? b: (a > c? c : a);}